# è®­ç»ƒè¶…å‚æ•°é…ç½®æ–‡ä»¶
# Training Hyperparameters Configuration

# ====================================================================================
# è®­ç»ƒæ¨¡å¼é€‰æ‹©
# ====================================================================================
training_mode:
  # è®­ç»ƒæµç¨‹: 'pretrain_finetune' æˆ– 'direct_train'
  # pretrain_finetune: å¯¹æ¯”å­¦ä¹ é¢„è®­ç»ƒ + æœ‰ç›‘ç£å¾®è°ƒ
  # direct_train: ç›´æ¥æœ‰ç›‘ç£è®­ç»ƒ(è·³è¿‡é¢„è®­ç»ƒ)
  pipeline: 'direct_train'  # 'pretrain_finetune' | 'direct_train'
  
  # æ˜¯å¦å¯ç”¨mixup
  use_mixup: false
  # æ˜¯å¦å¯ç”¨ç‰¹å¾å±‚mixup
  use_feature_mixup: false

# ====================================================================================
# å¯¹æ¯”å­¦ä¹ é¢„è®­ç»ƒé˜¶æ®µ
# ====================================================================================
pretrain:
  # è®­ç»ƒè½®æ•°
  epochs: 30
  
  # Batch size
  batch_size: 64
  
  # ä¼˜åŒ–å™¨
  optimizer:
    type: 'adamw'  # 'adam', 'adamw', 'sgd'
    lr: 0.001
    weight_decay: 0.0001
    betas: [0.9, 0.999]
    momentum: 0.9  # ä»…SGDä½¿ç”¨
  
  # å­¦ä¹ ç‡è°ƒåº¦å™¨
  scheduler:
    type: 'cosine_warm_restarts'  # è°ƒåº¦å™¨ç±»å‹
    # CosineAnnealingWarmRestartså‚æ•°
    T_0: 10  # é‡å¯å‘¨æœŸ
    T_mult: 1  # é‡å¯å‘¨æœŸå€å¢å› å­
    eta_min: 0.000001  # æœ€å°å­¦ä¹ ç‡
    # Warmupå‚æ•° (å¯é€‰)
    warmup_epochs: 3  # é¢„çƒ­è½®æ•°
    warmup_start_lr: 0.0001  # é¢„çƒ­èµ·å§‹å­¦ä¹ ç‡

  # å¯¹æ¯”å­¦ä¹ æŸå¤±
  loss:
    type: 'ntxent'  # 'ntxent' | 'supcon'
    temperature: 0.07

  # æ—©åœ
  early_stopping:
    enable: true
    patience: 8
    monitor: 'loss'  # é¢„è®­ç»ƒç›‘æ§loss
    mode: 'min'

  # æ¢¯åº¦è£å‰ª
  gradient_clip:
    enable: true
    max_norm: 1.0

# ====================================================================================
# æœ‰ç›‘ç£å¾®è°ƒé˜¶æ®µ
# ====================================================================================
finetune:
  # è®­ç»ƒè½®æ•°
  epochs: 100

  # Batch size
  batch_size: 32

  # ä¼˜åŒ–å™¨
  optimizer:
    type: 'adamw'
    lr: 0.0003  # å¾®è°ƒé˜¶æ®µä½¿ç”¨è¾ƒå°å­¦ä¹ ç‡
    weight_decay: 0.0001
    betas: [0.9, 0.999]

  # å­¦ä¹ ç‡è°ƒåº¦å™¨
  scheduler:
    type: 'cosine'  # è°ƒåº¦å™¨ç±»å‹
    # CosineAnnealingLRå‚æ•°
    T_max: 97  # 100 - warmup_epochs
    eta_min: 0.000001
    # Warmupå‚æ•°
    warmup_epochs: 3
    warmup_start_lr: 0.00005

  # æŸå¤±å‡½æ•°é…ç½®
  loss:
    # ä½¿ç”¨æ¸è¿›å¼æŸå¤±æƒé‡
    use_progressive: false

    # Focal Loss
    focal:
      alpha: null  # ç±»åˆ«æƒé‡(nullè¡¨ç¤ºè‡ªåŠ¨è®¡ç®—)
      weight: 0.6
      gamma_init: 2.0
      gamma_min: 1.0
    # ArcFace Loss
    arcface:
      s: 30.0  # ç‰¹å¾ç¼©æ”¾å› å­
      m: 0.5   # margin
      weight_init: 0.3
      weight_max: 0.7
    # Center Loss
    center:
      num_features: 768  # èåˆåç‰¹å¾ç»´åº¦
      lambda_c: 0.1
      weight: 0.1
    # label Smoothing
    label_smoothing: 0.1

  # æ—©åœ
  early_stopping:
    enable: true
    patience: 15
    monitor: 'val_accuracy'  # å¾®è°ƒç›‘æ§å‡†ç¡®ç‡
    mode: 'max'

  # æ¢¯åº¦è£å‰ª
  gradient_clip:
    enable: true
    max_norm: 1.0

  # å†»ç»“backboneç­–ç•¥
  freeze_backbone:
    enable: false
    freeze_ratio: 0.5  # å†»ç»“å‰50%çš„å±‚
    unfreeze_epoch: 20  # ç¬¬20ä¸ªepochè§£å†»

# ====================================================================================
# Mixupé…ç½®
# ====================================================================================
mixup:
  # Alphaå‚æ•°(æ§åˆ¶æ··åˆç¨‹åº¦)
  alpha: 0.1
  # åº”ç”¨æ¦‚ç‡
  prob: 0.5
  # æ˜¯å¦åœ¨ç‰¹å¾å±‚åº”ç”¨(æš‚ä¸å¯ç”¨)
  feature_mixup: false

# ====================================================================================
# æ•°æ®åŠ è½½
# ====================================================================================
data:
  # æ•°æ®ç›®å½•
  train_dir: 'raw_datasets/train'
  test_dir: 'raw_datasets/test'

  # çª—å£å‚æ•°
  window_size: 512
  window_step: 256

  # æ—¶é¢‘å˜æ¢æ–¹æ³•: 'stft' | 'cwt'
  timefreq_method: 'stft'

  # K-foldäº¤å‰éªŒè¯
  n_folds: 5
  current_fold: 0

  # DataLoaderå‚æ•°
  num_workers: 4
  pin_memory: true

  # æ˜¯å¦ç¼“å­˜æ•°æ®åˆ°å†…å­˜
  cache_data: true

# ====================================================================================
# å®éªŒç®¡ç†
# ====================================================================================
experiment:
  # å®éªŒåç§°
  name: 'bearing_diagnosis'

  # å®éªŒä¿å­˜ç›®å½•
  save_dir: 'experiments/runs'

  # æ—¥å¿—
  logging:
    # æ˜¯å¦ä½¿ç”¨tensorboard
    use_tensorboard: true
    # æ—¥å¿—ä¿å­˜é¢‘ç‡(æ¯Nä¸ªbatchè®°å½•ä¸€æ¬¡)
    log_interval: 10

  # å¯è§†åŒ–
  visualization:
    # æ˜¯å¦ä¿å­˜è®­ç»ƒæ›²çº¿
    save_curves: true
    # æ˜¯å¦ä¿å­˜æ··æ·†çŸ©é˜µ
    save_confusion_matrix: true
    # æ˜¯å¦ä¿å­˜t-SNEå¯è§†åŒ–
    save_tsne: true
    # æ˜¯å¦ä¿å­˜æ³¨æ„åŠ›å¯è§†åŒ–
    save_attention: true

# ====================================================================================
# éšæœºç§å­(ä¿è¯å¯å¤ç°)
# ====================================================================================
seed: 42

# ====================================================================================
# è®¾å¤‡
# ====================================================================================
device:
  # 'cuda' | 'cpu' | 'cuda:0'
  type: 'cuda'
  # æ˜¯å¦ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒ
  use_amp: false


# ====================================================================================
# è°ƒåº¦å™¨é…ç½®è¯´æ˜
# ====================================================================================
# ğŸ“– æ”¯æŒçš„è°ƒåº¦å™¨ç±»å‹åŠå…¶å‚æ•°:
#
# 1. 'step' - StepLR
#    å‚æ•°: step_size, gamma
#
# 2. 'multistep' - MultiStepLR
#    å‚æ•°: milestones, gamma
#
# 3. 'cosine' - CosineAnnealingLR
#    å‚æ•°: T_max, eta_min
#
# 4. 'cosine_warm_restarts' - CosineAnnealingWarmRestarts
#    å‚æ•°: T_0, T_mult, eta_min
#
# 5. 'plateau' / 'reduce_on_plateau' - ReduceLROnPlateau
#    å‚æ•°: mode, factor, patience, threshold
#    æ³¨æ„: æ­¤è°ƒåº¦å™¨éœ€è¦ä¼ å…¥metric,trainerä¼šè‡ªåŠ¨å¤„ç†
#
# 6. 'exponential' - ExponentialLR
#    å‚æ•°: gamma
#
# 7. 'cyclic' - CyclicLR
#    å‚æ•°: base_lr, max_lr, step_size_up
#
# 8. 'onecycle' - OneCycleLR
#    å‚æ•°: max_lr_onecycle, total_steps æˆ– (epochs, steps_per_epoch)
#
# ğŸ”¥ Warmupæ”¯æŒ:
#    ä»»ä½•è°ƒåº¦å™¨éƒ½å¯ä»¥æ·»åŠ warmupå‚æ•°:
#    - warmup_epochs: é¢„çƒ­è½®æ•°
#    - warmup_start_lr: é¢„çƒ­èµ·å§‹å­¦ä¹ ç‡
#
#    ç¤ºä¾‹:
#    scheduler:
#      type: 'cosine'
#      T_max: 97
#      eta_min: 1e-6
#      warmup_epochs: 3
#      warmup_start_lr: 1e-5
#
# ğŸ”¥ Combinedè°ƒåº¦å™¨ (é«˜çº§ç”¨æ³•):
#    å¯ä»¥åœ¨ä¸åŒepochä½¿ç”¨ä¸åŒè°ƒåº¦å™¨
#    scheduler:
#      type: 'combined'
#      schedulers_config:
#        - {type: 'warmup', warmup_epochs: 5, warmup_start_lr: 1e-5}
#        - {type: 'cosine', T_max: 45, eta_min: 1e-6}
#      switch_epochs: [5]  # åœ¨epoch 5åˆ‡æ¢
#
# ====================================================================================

